<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mein Profil</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <nav>
      <ul>
        <li><a href="../Index.html"><i class="fas fa-home"></i> Startseite</a></li>
        <li><a href="Progress.html"><i class="fas fa-list"></i> Mein Fortschritt</a></li>
        <li><a href="#"><i class="fas fa-comments"></i> Community</a></li>
        <li><a href="#" id="meinProfil"><i class="fas fa-user"></i> Mein Profil</a></li>
      </ul>
    </nav>
    <div class="container card" style="max-width:500px; margin:2em auto; text-align:center;">
        <h2>ðŸ‘¤ Profil</h2>
        <div id="profile-info">
            <p>Lade Profil ...</p>
        </div>
        <h3 style="margin-top:2em;">Fortschritt</h3>
        <ul id="progress-list" style="text-align:left;"></ul>
        <button class="btn" id="logoutBtn" style="margin-top:2em;">Abmelden</button>
        
        <!-- Profilbild-Auswahl -->
        <div style="margin:2em 0;">
            <h3>Profilbild wÃ¤hlen</h3>
            <div id="avatar-selection" style="display:flex; justify-content:center; gap:2em; margin-bottom:1em;"></div>
            <button class="btn" id="saveAvatarBtn">Profilbild speichern</button>
            <div id="avatar-success" style="color:green; margin-top:1em;"></div>
        </div>
    </div>
    <script>
    fetch('../php/profile_info.php')
      .then(r => r.json())
      .then(data => {
        if(data.success) {
          // Hole Email zusÃ¤tzlich per Session-Check
          fetch('../php/auth.php', {
            method: 'POST',
            headers: {'Content-Type':'application/x-www-form-urlencoded'},
            body: 'action=check'
          })
          .then(r => r.json())
          .then(loginData => {
            let email = loginData.email ? loginData.email : '-';
            document.getElementById('profile-info').innerHTML = `   
              <p><strong>Name:</strong> ${data.username}</p>
              <p><strong>Email:</strong> ${email}</p>
            `;
          });
          if(data.units && data.units.length) {
            document.getElementById('progress-list').innerHTML = data.units.map(unit =>
              `<li class='card' style='margin-bottom:1em;'>
                <strong>${unit.unit_name}</strong><br>
                <span>${unit.description || ''}</span><br>
                <strong>Level:</strong> ${unit.progress_level} <br>
                <strong>Letztes Ãœben:</strong> ${unit.last_practiced}
              </li>`
            ).join('');
          } else {
            document.getElementById('progress-list').innerHTML = '<li>Kein Fortschritt vorhanden.</li>';
          }
        } else {
          document.getElementById('profile-info').innerHTML = `<p style='color:red;'>${data.message || 'Nicht eingeloggt.'}</p>`;
          document.getElementById('progress-list').innerHTML = '';
        }
      });
    document.getElementById('logoutBtn').addEventListener('click', function() {
      fetch('../php/auth.php', {
        method: 'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded'},
        body: 'action=logout'
      })
      .then(r => r.json())
      .then(() => window.location.href = '../Index.html');
    });
    
    // Profilbild-Auswahl
    const avatarImages = [
      '../html/ProfilBild-Loewe.jpg',
      '../html/ProfilBild-frosch.jpg',
      '../html/ProfilBild-Schnecke.jpg'
    ];
    let selectedAvatar = null;

    function renderAvatars(currentAvatar) {
      const avatarDiv = document.getElementById('avatar-selection');
      avatarDiv.innerHTML = avatarImages.map(img =>
        `<img src="${img}" class="avatar-img${currentAvatar===img?' selected':''}" data-avatar="${img}" style="width:80px; height:80px; border-radius:50%; border:3px solid var(--primary-color); cursor:pointer; box-shadow:0 2px 8px #0001; object-fit:cover;${currentAvatar===img?' box-shadow:0 0 0 4px var(--accent-color);':''}">`
      ).join('');
      document.querySelectorAll('.avatar-img').forEach(img => {
        img.onclick = function() {
          document.querySelectorAll('.avatar-img').forEach(i=>i.classList.remove('selected'));
          img.classList.add('selected');
          selectedAvatar = img.getAttribute('data-avatar');
        };
      });
    }

    // Profil laden und Avatar anzeigen
    fetch('../php/profile_info.php')
      .then(r => r.json())
      .then(data => {
        if(data.success) {
          // ...existing code...
          // Avatar initialisieren
          selectedAvatar = data.avatar || avatarImages[0];
          renderAvatars(selectedAvatar);
          // ...existing code...
        }
      });

    document.getElementById('saveAvatarBtn').onclick = function() {
      if(!selectedAvatar) return;
      fetch('../php/profile_info.php', {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:'set_avatar=1&avatar='+encodeURIComponent(selectedAvatar)
      })
      .then(r=>r.json())
      .then(res=>{
        if(res.success) {
          document.getElementById('avatar-success').textContent = 'Profilbild gespeichert!';
        }
      });
    };
    </script>
</body>
</html>